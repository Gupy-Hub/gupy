<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Performance</title>
    <link rel="icon" href="assets/img/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>.selected-row td {background:#eff6ff !important; color:var(--primary); font-weight:700;} .hidden{display:none !important}</style>
</head>
<body>
<div class="container">
    <div class="top-controls">
        <div class="control-group" style="flex:1.5"><label>Assistente</label><select id="user-selector" onchange="carregarPerformance()"></select></div>
        <div class="control-group"><label>Tipo</label><select id="period-type" onchange="atualizarOpcoes()"><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano">Anual</option></select></div>
        <div class="control-group"><label>Ano</label><select id="year-selector" onchange="atualizarOpcoes()"></select></div>
        <div class="control-group" style="flex:1.2"><label>Período</label><select id="period-value" onchange="carregarPerformance()"></select></div>
    </div>
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="kpi-total">0</div></div>
        <div class="stat-card"><div class="stat-label">Média</div><div class="stat-value" id="kpi-media">0</div></div>
        <div class="stat-card"><div class="stat-label">Meta</div><div class="stat-value" id="kpi-meta">0</div></div>
        <div class="stat-card"><div class="stat-label">Ranking</div><div class="stat-value" id="kpi-rank">-</div></div>
    </div>
    <div class="table-card">
        <table><thead><tr><th>#</th><th>Nome</th><th>Total</th><th>Dias</th><th>Média</th><th>Meta</th><th>Status</th></tr></thead><tbody id="comparative-body"></tbody></table>
    </div>
</div>
<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', init);
    async function init() {
        const ys = document.getElementById('year-selector'); const cy = new Date().getFullYear();
        ys.innerHTML=''; for(let y=cy; y>=2024; y--) ys.innerHTML+=`<option value="${y}">${y}</option>`;
        await loadUsers(); atualizarOpcoes();
    }
    async function loadUsers() {
        const { data } = await _supabase.from('usuarios').select('*').order('nome');
        const sel = document.getElementById('user-selector'); sel.innerHTML='';
        data.filter(u=>u.funcao!=='Gestora').forEach(u=>sel.innerHTML+=`<option value="${u.id}">${u.nome}</option>`);
    }
    function atualizarOpcoes() {
        const type = document.getElementById('period-type').value;
        const sel = document.getElementById('period-value'); sel.innerHTML='';
        if(type==='mes') ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].forEach((m,i)=>sel.innerHTML+=`<option value="${i+1}" ${i===new Date().getMonth()?'selected':''}>${m}</option>`);
        else if(type==='trimestre') sel.innerHTML='<option value="1">1º Tri</option><option value="2">2º Tri</option><option value="3">3º Tri</option><option value="4">4º Tri</option>';
        else if(type==='semestre') sel.innerHTML='<option value="1">1º Sem</option><option value="2">2º Sem</option>';
        else sel.innerHTML='<option value="1">Ano Completo</option>';
        carregarPerformance();
    }
    async function carregarPerformance() {
        const uid = document.getElementById('user-selector').value; if(!uid) return;
        const year = document.getElementById('year-selector').value; const val = parseInt(document.getElementById('period-value').value); const type = document.getElementById('period-type').value;
        let s='', e='';
        if(type==='mes'){ s=`${year}-${val.toString().padStart(2,'0')}-01`; e=`${year}-${val.toString().padStart(2,'0')}-${new Date(year,val,0).getDate()}`; }
        else if(type==='trimestre'){ const m1=((val-1)*3)+1; s=`${year}-${m1.toString().padStart(2,'0')}-01`; e=`${year}-${(m1+2).toString().padStart(2,'0')}-${new Date(year,m1+2,0).getDate()}`; }
        else if(type==='semestre'){ s=val===1?`${year}-01-01`:`${year}-07-01`; e=val===1?`${year}-06-30`:`${year}-12-31`; }
        else { s=`${year}-01-01`; e=`${year}-12-31`; }

        const { data:dt } = await _supabase.from('producao').select('*, usuarios(nome)').gte('data_referencia', s).lte('data_referencia', e);
        const { data:mts } = await _supabase.from('metas').select('*');
        
        let stats={};
        (dt||[]).forEach(d=>{ if(!stats[d.usuario_id]) stats[d.usuario_id]={id:d.usuario_id, nome:d.usuarios.nome, total:0, dias:new Set()}; stats[d.usuario_id].total+=d.quantidade; stats[d.usuario_id].dias.add(d.data_referencia); });
        
        let list = Object.values(stats).map(i=>{
            const dc = i.dias.size||1;
            const mt = mts.find(m=>m.usuario_id==i.id && m.data_inicio<=e)?.valor_meta||650;
            return {...i, media:(i.total/dc).toFixed(0), diasCount:dc, metaTotal: mt*dc};
        }).sort((a,b)=>b.total-a.total);

        render(list, uid);
    }
    function render(list, uid) {
        const me = list.find(i=>i.id==uid);
        if(me) {
            document.getElementById('kpi-total').innerText=me.total.toLocaleString();
            document.getElementById('kpi-media').innerText=me.media;
            document.getElementById('kpi-meta').innerText=me.metaTotal.toLocaleString();
            document.getElementById('kpi-rank').innerText='#'+(list.findIndex(i=>i.id==uid)+1);
        } else { ['kpi-total','kpi-media','kpi-meta','kpi-rank'].forEach(i=>document.getElementById(i).innerText='-'); }
        
        let h='';
        list.forEach((i,idx)=>{
            const ok = i.total>=i.metaTotal;
            h+=`<tr class="${i.id==uid?'selected-row':''}"><td>${idx+1}</td><td>${i.nome}</td><td>${i.total}</td><td>${i.diasCount}</td><td>${i.media}</td><td>${i.metaTotal}</td><td><span class="badge" style="background:${ok?'var(--success)':'var(--danger)'}">${ok?'Sim':'Não'}</span></td></tr>`;
        });
        document.getElementById('comparative-body').innerHTML=h||'<tr><td colspan="7" style="text-align:center">Sem dados</td></tr>';
    }
</script>
</body>
</html>
