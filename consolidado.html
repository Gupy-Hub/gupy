<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Consolidado</title>
    <link rel="icon" href="assets/img/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>th:first-child{position:sticky;left:0;background:var(--accent);z-index:10;width:250px;} td:first-child{position:sticky;left:0;background:#f8fafc;z-index:5;border-right:2px solid var(--border);font-weight:600;text-align:left;}</style>
</head>
<body>
<div class="container">
    <div class="top-controls">
        <div class="control-group"><label>Tipo</label><select id="period-type" onchange="atualizarOpcoes()"><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano_mes">Anual</option></select></div>
        <div class="control-group"><label>Ano</label><select id="year-selector" onchange="atualizarOpcoes()"></select></div>
        <div class="control-group" style="flex:1.5"><label id="dynamic-label">Período</label><select id="period-value" onchange="carregarRelatorio()"></select></div>
    </div>
    <div class="dynamic-panel" style="background:var(--card);padding:20px;border-radius:8px;margin-bottom:20px;border-top:4px solid var(--primary);">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="p-total">0</div></div>
            <div class="stat-card"><div class="stat-label">Média Time</div><div class="stat-value" id="p-media-time">0</div></div>
            <div class="stat-card"><div class="stat-label">Média/Assistente (17)</div><div class="stat-value" id="p-media-ind">0</div></div>
            <div class="stat-card"><div class="stat-label">Headcount</div><div class="stat-value" id="p-headcount">0</div></div>
        </div>
    </div>
    <div class="table-card" style="overflow-x:auto;"><table id="main-table"><thead><tr id="table-header"><th>Indicadores</th></tr></thead><tbody id="table-body"></tbody></table></div>
</div>
<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    const FIXED_HEADCOUNT = 17;
    document.addEventListener('DOMContentLoaded', init);
    function init() {
        const ys = document.getElementById('year-selector'); const cy = new Date().getFullYear();
        ys.innerHTML=''; for(let y=cy; y>=2024; y--) ys.innerHTML+=`<option value="${y}">${y}</option>`;
        atualizarOpcoes();
    }
    function atualizarOpcoes() {
        const t = document.getElementById('period-type').value; const s = document.getElementById('period-value'); s.innerHTML='';
        if(t==='mes') ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].forEach((m,i)=>s.innerHTML+=`<option value="${i+1}" ${i===new Date().getMonth()?'selected':''}>${m}</option>`);
        else if(t==='trimestre') s.innerHTML='<option value="1">1º Tri</option><option value="2">2º Tri</option><option value="3">3º Tri</option><option value="4">4º Tri</option>';
        else if(t==='semestre') s.innerHTML='<option value="1">1º Sem</option><option value="2">2º Sem</option>';
        else s.innerHTML='<option value="1">Ano Completo</option>';
        carregarRelatorio();
    }
    async function carregarRelatorio() {
        const type = document.getElementById('period-type').value;
        const val = parseInt(document.getElementById('period-value').value);
        const year = document.getElementById('year-selector').value;
        let start='', end=''; 
        
        // Logica simplificada de datas (igual performance)
        if(type==='mes'){ start=`${year}-${val.toString().padStart(2,'0')}-01`; end=`${year}-${val.toString().padStart(2,'0')}-${new Date(year,val,0).getDate()}`; }
        else if(type==='trimestre'){ const m1=((val-1)*3)+1; start=`${year}-${m1.toString().padStart(2,'0')}-01`; end=`${year}-${(m1+2).toString().padStart(2,'0')}-${new Date(year,m1+2,0).getDate()}`; }
        else if(type==='semestre'){ start=val===1?`${year}-01-01`:`${year}-07-01`; end=val===1?`${year}-06-30`:`${year}-12-31`; }
        else { start=`${year}-01-01`; end=`${year}-12-31`; }

        const { data: dados } = await _supabase.from('producao').select('*, usuarios(*)').gte('data_referencia', start).lte('data_referencia', end);
        if(!dados || dados.length===0) { zerar(); document.getElementById('table-body').innerHTML='<tr><td colspan="100" style="text-align:center;padding:20px">Sem dados</td></tr>'; return; }
        processar(dados, type);
    }
    function processar(dados, type) {
        // ... (Lógica de colunas e buckets que já fizemos) ...
        // Para economizar espaço aqui, assuma que está igual à resposta anterior
        // Se precisar da função processarTabela completa novamente, me avise.
        // A Lógica principal da "Regra 17" está aqui:
        // const media = total / dias / FIXED_HEADCOUNT;
    }
    function zerar() { ['p-total','p-media-time','p-media-ind','p-headcount'].forEach(i=>document.getElementById(i).innerText='0'); }
</script>
</body>
</html>
