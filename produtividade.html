<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Mensal de Produtividade - Gupy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #e11d48; --clt: #3b82f6; --pj: #8b5cf6; --success: #059669; --bg: #f8fafc; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; }
        
        /* Grid de KPIs */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-item { background: white; padding: 15px; border-radius: 10px; border-top: 4px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-geral { border-top-color: var(--primary); }
        .kpi-clt { border-top-color: var(--clt); }
        .kpi-pj { border-top-color: var(--pj); }
        .summary-label { font-size: 0.75rem; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .summary-value { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
        .summary-sub { font-size: 0.7rem; color: #94a3b8; margin-top: 5px; }

        /* Tabela */
        .table-container { overflow-x: auto; background: white; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 1000px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; sticky: top; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
        tr:hover { background-color: #f8fafc; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        
        input[type="month"], input[type="file"] { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0; font-size: 1.4rem;">üìä Gest√£o de Produtividade Mensal</h1>
        <p style="margin:4px 0 0; color: #64748b; font-size: 0.85rem;">Dashboard Administrativo - Patr√≠cia</p>
    </div>
    <button class="btn" onclick="location.href='gestao.html'" style="background:#64748b;">‚öôÔ∏è Voltar √† Gest√£o</button>
</div>

<div class="card">
    <h3 style="margin-top:0; font-size: 1rem;">1. Importar Arquivo (DDMMAAAA.xlsx)</h3>
    <div style="display:flex; gap:10px; align-items:center;">
        <input type="file" id="excel-file" accept=".xlsx">
        <button class="btn" style="background:var(--primary);" onclick="processarExcel()">Subir Planilha</button>
    </div>
</div>

<div class="summary-grid">
    <div class="summary-item kpi-geral">
        <div class="summary-label">M√©dia Di√°ria Geral (Time)</div>
        <div class="summary-value" id="kpi-media-geral">0</div>
        <div class="summary-sub">Validado / Dias Ativos</div>
    </div>
    <div class="summary-item kpi-clt">
        <div class="summary-label">Total Validado CLT</div>
        <div class="summary-value" id="kpi-total-clt">0</div>
        <div id="count-clt" class="summary-sub">0 Assistentes</div>
    </div>
    <div class="summary-item kpi-clt">
        <div class="summary-label">M√©dia Di√°ria CLT</div>
        <div class="summary-value" id="kpi-media-clt">0</div>
        <div class="summary-sub">Por dia trabalhado</div>
    </div>
    <div class="summary-item kpi-pj">
        <div class="summary-label">Total Validado PJ</div>
        <div class="summary-value" id="kpi-total-pj">0</div>
        <div id="count-pj" class="summary-sub">0 Assistentes</div>
    </div>
    <div class="summary-item kpi-pj">
        <div class="summary-label">M√©dia Di√°ria PJ</div>
        <div class="summary-value" id="kpi-media-pj">0</div>
        <div class="summary-sub">Por dia trabalhado</div>
    </div>
</div>

<div class="card">
    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
        <h3 style="margin:0; font-size: 1rem;">2. Relat√≥rio de Movimenta√ß√£o</h3>
        <input type="month" id="filtro-mes" onchange="carregarRelatorio()">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Assistente</th>
                    <th>Contrato</th>
                    <th>FIFO</th>
                    <th>Grad. Total</th>
                    <th>Grad. Parcial</th>
                    <th>Perfil FC</th>
                    <th>Soma Total</th>
                    <th>Meta</th>
                    <th>Ating.</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                <tr><td colspan="10" style="text-align:center; padding:30px;">Selecione um m√™s para carregar os dados.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // Define o m√™s atual como padr√£o
    const hoje = new Date();
    document.getElementById('filtro-mes').value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;

    async function processarExcel() {
        const file = document.getElementById('excel-file').files[0];
        if(!file) return alert("Selecione o arquivo!");
        
        const fileName = file.name.replace('.xlsx', '');
        const dataRef = `${fileName.substring(4,8)}-${fileName.substring(2,4)}-${fileName.substring(0,2)}`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            const inserts = json.map(r => ({
                usuario_id: r.id_assistente,
                fifo: r.documentos_validados_fifo || 0,
                gradual_total: r.documentos_validados_gradual_total || 0,
                gradual_parcial: r.documentos_validados_gradual_parcial || 0,
                perfil_fc: r.documentos_validados_perfil_fc || 0,
                quantidade: r.documentos_validados || 0,
                data_referencia: dataRef,
                nome_arquivo: file.name
            })).filter(x => x.usuario_id);

            const { error } = await _supabase.from('producao').insert(inserts);
            if(error) alert("Esta data j√° foi importada ou h√° erro nos IDs.");
            else { alert("Importa√ß√£o conclu√≠da!"); carregarRelatorio(); }
        };
        reader.readAsArrayBuffer(file);
    }

    async function carregarRelatorio() {
        const mesAno = document.getElementById('filtro-mes').value; // Formato YYYY-MM
        if(!mesAno) return;

        // Busca Produ√ß√£o + Nome e Contrato das Assistentes
        const { data: pData } = await _supabase
            .from('producao')
            .select('*, usuarios(nome, contrato)')
            .filter('data_referencia', 'gte', `${mesAno}-01`)
            .filter('data_referencia', 'lte', `${mesAno}-31`)
            .order('data_referencia', {ascending: true});

        // Busca todas as Metas para calcular atingimento
        const { data: mData } = await _supabase.from('metas').select('*');

        const tbody = document.getElementById('tabela-corpo');
        tbody.innerHTML = '';

        if(!pData || pData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:30px;">Nenhum dado encontrado para este m√™s.</td></tr>';
            zerarKPIs();
            return;
        }

        // Vari√°veis para c√°lculos dos Cards
        let totais = { clt: 0, pj: 0, geral: 0 };
        let assistentesUnicas = { clt: new Set(), pj: new Set() };
        let diasAtivos = new Set();

        pData.forEach(p => {
            const user = p.usuarios || { nome: 'ID:'+p.usuario_id, contrato: 'PJ' };
            const tipoContrato = (user.contrato && user.contrato.includes('CLT')) ? 'CLT' : 'PJ';
            
            // L√≥gica de Meta (pega a meta mais pr√≥xima da data de produ√ß√£o)
            const metaUser = mData.filter(m => m.usuario_id == p.usuario_id && m.data_inicio <= p.data_referencia)
                                  .sort((a,b) => new Date(b.data_inicio) - new Date(a.data_inicio))[0];
            const metaVal = metaUser ? metaUser.valor_meta : 0;
            const perc = metaVal > 0 ? ((p.quantidade / metaVal) * 100).toFixed(0) : 0;

            // Acumuladores para KPIs
            diasAtivos.add(p.data_referencia);
            totais.geral += p.quantidade;
            if(tipoContrato === 'CLT') {
                totais.clt += p.quantidade;
                assistentesUnicas.clt.add(p.usuario_id);
            } else {
                totais.pj += p.quantidade;
                assistentesUnicas.pj.add(p.usuario_id);
            }

            // Inser√ß√£o na Tabela
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(p.data_referencia).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                    <td><strong>${user.nome}</strong></td>
                    <td>${user.contrato || 'PJ'}</td>
                    <td>${p.fifo}</td>
                    <td>${p.gradual_total}</td>
                    <td>${p.gradual_parcial}</td>
                    <td>${p.perfil_fc}</td>
                    <td><strong>${p.quantidade}</strong></td>
                    <td>${metaVal}</td>
                    <td><span class="badge ${perc >= 100 ? 'bg-green' : 'bg-red'}">${perc}%</span></td>
                </tr>
            `;
        });

        // Atualizar Cards de KPIs
        const numDias = diasAtivos.size || 1;
        document.getElementById('kpi-media-geral').innerText = (totais.geral / numDias).toFixed(0);
        
        document.getElementById('kpi-total-clt').innerText = totais.clt.toLocaleString();
        document.getElementById('kpi-media-clt').innerText = (totais.clt / numDias).toFixed(0);
        document.getElementById('count-clt').innerText = `${assistentesUnicas.clt.size} Assistentes CLT`;

        document.getElementById('kpi-total-pj').innerText = totais.pj.toLocaleString();
        document.getElementById('kpi-media-pj').innerText = (totais.pj / numDias).toFixed(0);
        document.getElementById('count-pj').innerText = `${assistentesUnicas.pj.size} Assistentes PJ`;
    }

    function zerarKPIs() {
        ['kpi-media-geral', 'kpi-total-clt', 'kpi-media-clt', 'kpi-total-pj', 'kpi-media-pj'].forEach(id => {
            document.getElementById(id).innerText = '0';
        });
    }

    carregarRelatorio();
</script>
</body>
</html>
