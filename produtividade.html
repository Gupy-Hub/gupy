<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard GestÃ£o - Gupy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #e11d48; --clt: #3b82f6; --pj: #8b5cf6; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; background: var(--primary); }
        
        /* Grid de KPIs do Time */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-item { background: white; padding: 15px; border-radius: 10px; border-top: 4px solid #cbd5e1; }
        .kpi-geral { border-top-color: var(--primary); }
        .kpi-clt { border-top-color: var(--clt); }
        .kpi-pj { border-top-color: var(--pj); }
        .summary-label { font-size: 0.7rem; color: #64748b; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .summary-value { font-size: 1.4rem; font-weight: 800; }

        /* Tabela Customizada */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 1200px; }
        th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .row-total-month { background: #fff1f2; font-weight: bold; }
        .badge-info { background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0; font-size: 1.2rem;">ðŸ“Š Painel de Controle de Produtividade</h1>
        <p style="margin:0; font-size: 0.8rem; color: #64748b;">RelatÃ³rios Consolidados para GestÃ£o</p>
    </div>
    <button class="btn" style="background:#64748b;" onclick="location.href='gestao.html'">ConfiguraÃ§Ãµes</button>
</div>

<div class="summary-grid">
    <div class="summary-item kpi-geral">
        <div class="summary-label">MÃ©dia DiÃ¡ria Geral (Time)</div>
        <div class="summary-value" id="time-media-geral">0</div>
    </div>
    <div class="summary-item kpi-clt">
        <div class="summary-label">Total Validado CLT</div>
        <div class="summary-value" id="time-total-clt">0</div>
    </div>
    <div class="summary-item kpi-clt">
        <div class="summary-label">MÃ©dia DiÃ¡ria CLT</div>
        <div class="summary-value" id="time-media-clt">0</div>
    </div>
    <div class="summary-item kpi-pj">
        <div class="summary-label">Total Validado PJ</div>
        <div class="summary-value" id="time-total-pj">0</div>
    </div>
    <div class="summary-item kpi-pj">
        <div class="summary-label">MÃ©dia DiÃ¡ria PJ</div>
        <div class="summary-value" id="time-media-pj">0</div>
    </div>
</div>

<div class="card">
    <div style="display:flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 15px;">
        <div>
            <label style="display:block; font-size: 0.8rem; margin-bottom: 5px;">Importar Novo Dia (.xlsx)</label>
            <input type="file" id="excel-file" accept=".xlsx">
            <button class="btn" onclick="processarExcel()">Subir Planilha</button>
        </div>
        <div>
            <label style="display:block; font-size: 0.8rem; margin-bottom: 5px;">MÃªs de ReferÃªncia</label>
            <input type="month" id="filtro-mes" onchange="carregarDados()">
        </div>
    </div>
</div>

<div class="card">
    <h3>RelatÃ³rio Detalhado por Assistente</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Assistente (Contrato)</th>
                    <th>FIFO</th>
                    <th>Grad. Total</th>
                    <th>Grad. Parcial</th>
                    <th>Perfil FC</th>
                    <th>Total Dia</th>
                    <th>Total Semana</th>
                    <th>Total MÃªs</th>
                    <th>MÃ©dia Mensal</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                <tr><td colspan="10" style="text-align:center;">Carregando dados...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    document.getElementById('filtro-mes').value = new Date().toISOString().substring(0, 7);

    async function processarExcel() {
        const file = document.getElementById('excel-file').files[0];
        if(!file) return alert("Selecione o arquivo!");
        const fileName = file.name.replace('.xlsx', '');
        const dataRef = `${fileName.substring(4,8)}-${fileName.substring(2,4)}-${fileName.substring(0,2)}`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const inserts = json.map(r => ({
                usuario_id: r.id_assistente,
                fifo: r.documentos_validados_fifo || 0,
                gradual_total: r.documentos_validados_gradual_total || 0,
                gradual_parcial: r.documentos_validados_gradual_parcial || 0,
                perfil_fc: r.documentos_validados_perfil_fc || 0,
                quantidade: r.documentos_validados || 0,
                data_referencia: dataRef,
                nome_arquivo: file.name
            })).filter(x => x.usuario_id);

            const { error } = await _supabase.from('producao').insert(inserts);
            if(error) alert("Erro ao importar."); else { alert("Sucesso!"); carregarDados(); }
        };
        reader.readAsArrayBuffer(file);
    }

    // FunÃ§Ã£o para pegar o nÃºmero da semana (ISO)
    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    async function carregarDados() {
        const mesAno = document.getElementById('filtro-mes').value;
        const { data: pData } = await _supabase.from('producao').select('*, usuarios(nome, contrato)').filter('data_referencia', 'gte', `${mesAno}-01`).filter('data_referencia', 'lte', `${mesAno}-31`).order('data_referencia');

        if(!pData) return;

        let statsUser = {}; // Para cÃ¡lculos mensais/semanais por usuÃ¡rio
        let kpiTime = { totalGeral: 0, totalCLT: 0, totalPJ: 0, diasAtivos: new Set() };

        // Primeiro passo: Processar totais por usuÃ¡rio
        pData.forEach(p => {
            const uid = p.usuario_id;
            const week = getWeekNumber(new Date(p.data_referencia));
            const contrato = (p.usuarios?.contrato || 'PJ').includes('CLT') ? 'CLT' : 'PJ';

            if(!statsUser[uid]) statsUser[uid] = { totalMes: 0, diasTrabalhados: 0, semanas: {} };
            
            statsUser[uid].totalMes += p.quantidade;
            statsUser[uid].diasTrabalhados++;
            statsUser[uid].semanas[week] = (statsUser[uid].semanas[week] || 0) + p.quantidade;

            kpiTime.totalGeral += p.quantidade;
            kpiTime.diasAtivos.add(p.data_referencia);
            if(contrato === 'CLT') kpiTime.totalCLT += p.quantidade; else kpiTime.totalPJ += p.quantidade;
        });

        // Segundo passo: Renderizar Tabela
        const tbody = document.getElementById('tabela-corpo');
        tbody.innerHTML = '';
        pData.forEach(p => {
            const uid = p.usuario_id;
            const week = getWeekNumber(new Date(p.data_referencia));
            const mediaMensal = (statsUser[uid].totalMes / statsUser[uid].diasTrabalhados).toFixed(0);

            tbody.innerHTML += `
                <tr>
                    <td>${new Date(p.data_referencia).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td>
                    <td><strong>${p.usuarios?.nome}</strong> <span class="badge-info">${p.usuarios?.contrato}</span></td>
                    <td>${p.fifo}</td>
                    <td>${p.gradual_total}</td>
                    <td>${p.gradual_parcial}</td>
                    <td>${p.perfil_fc}</td>
                    <td>${p.quantidade}</td>
                    <td><span style="color:#64748b">${statsUser[uid].semanas[week]}</span></td>
                    <td><strong>${statsUser[uid].totalMes}</strong></td>
                    <td>${mediaMensal}</td>
                </tr>
            `;
        });

        // Terceiro passo: Atualizar KPIs do Time
        const qtdDias = kpiTime.diasAtivos.size || 1;
        document.getElementById('time-media-geral').innerText = (kpiTime.totalGeral / qtdDias).toFixed(0);
        document.getElementById('time-total-clt').innerText = kpiTime.totalCLT.toLocaleString();
        document.getElementById('time-media-clt').innerText = (kpiTime.totalCLT / qtdDias).toFixed(0);
        document.getElementById('time-total-pj').innerText = kpiTime.totalPJ.toLocaleString();
        document.getElementById('time-media-pj').innerText = (kpiTime.totalPJ / qtdDias).toFixed(0);
    }

    carregarDados();
</script>
</body>
</html>
