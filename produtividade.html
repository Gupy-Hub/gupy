<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Produtividade</title>
    <link rel="icon" href="assets/img/favicon.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>.divider-row{background:var(--nav)!important;color:white!important;font-weight:700;} #import-log{position:fixed;bottom:20px;right:20px;background:white;padding:20px;border-left:5px solid var(--success);box-shadow:0 10px 40px rgba(0,0,0,0.15);display:none;}</style>
</head>
<body>
<div style="position:fixed;top:15px;right:250px;z-index:1100;display:flex;gap:10px;">
    <div class="nav-tools" style="background:rgba(255,255,255,0.1);padding:6px 15px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;">
        <select id="view-selector" onchange="ajustarSeletores()" style="background:transparent;border:none;color:white;font-weight:600;"><option value="dia" style="color:#333">üîç Dia</option><option value="semana" style="color:#333">üìÖ Semana</option><option value="mes" style="color:#333">üìä M√™s</option></select>
        <input type="date" id="select-dia" onchange="carregarDados()" style="background:transparent;border:none;color:white;">
        <input type="month" id="select-mes" class="hidden" onchange="sincronizarMes()" style="background:transparent;border:none;color:white;">
        <select id="select-semana" class="hidden" onchange="alternarVisao()" style="background:transparent;border:none;color:white;"><option value="1" style="color:#333">Sem 1</option><option value="2" style="color:#333">Sem 2</option><option value="3" style="color:#333">Sem 3</option><option value="4" style="color:#333">Sem 4</option><option value="5" style="color:#333">Sem 5</option></select>
    </div>
    <button onclick="document.getElementById('excel-files').click()" style="background:var(--accent);color:white;border:none;padding:8px 15px;border-radius:6px;font-weight:600;cursor:pointer;">Importar</button>
    <input type="file" id="excel-files" accept=".xlsx" multiple class="hidden" onchange="importarArquivos()">
</div>
<div class="container">
    <div class="dynamic-panel" style="background:var(--card);padding:20px;border-radius:8px;margin-bottom:20px;border-top:4px solid var(--primary);">
        <h2 id="panel-titulo" style="margin:0 0 15px 0;font-size:1.1rem;color:var(--nav);">Vis√£o Geral</h2>
        <div class="stats-grid"><div class="stat-card"><div class="stat-label">Total Geral</div><div class="stat-value" id="p-total">0</div></div><div class="stat-card"><div class="stat-label">M√©dia Time</div><div class="stat-value" id="p-media">0</div></div><div class="stat-card"><div class="stat-label">Assistentes</div><div class="stat-value" id="p-headcount">0</div></div></div>
    </div>
    <div class="table-wrap"><table><thead id="main-thead"><tr><th>Assistente</th><th>Produ√ß√£o</th><th>FIFO</th><th>G.T.</th><th>G.P.</th><th>P.FC</th><th>Meta</th><th>Status</th></tr></thead><tbody id="tabela-corpo"></tbody></table></div>
</div>
<div id="import-log"><h4 style="margin:0">Log</h4><div id="log-content"></div><button onclick="this.parentElement.style.display='none'" style="margin-top:10px;width:100%;">Fechar</button></div>
<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    let dadosGlobais=[], metasGlobais=[];
    const ontem=new Date(); ontem.setDate(ontem.getDate()-1);
    document.getElementById('select-dia').value=ontem.toISOString().split('T')[0];
    document.getElementById('select-mes').value=ontem.toISOString().substring(0,7);
    function ajustarSeletores(){ const v=document.getElementById('view-selector').value; const d=document.getElementById('select-dia'),m=document.getElementById('select-mes'),s=document.getElementById('select-semana'); d.classList.add('hidden');m.classList.add('hidden');s.classList.add('hidden'); if(v==='dia') d.classList.remove('hidden'); else if(v==='semana'){s.classList.remove('hidden');m.classList.remove('hidden');} else m.classList.remove('hidden'); carregarDados(); }
    function sincronizarMes(){ document.getElementById('select-dia').value=document.getElementById('select-mes').value+'-01'; carregarDados(); }
    async function carregarDados(){
        const v=document.getElementById('view-selector').value; const mes=v==='dia'?document.getElementById('select-dia').value.substring(0,7):document.getElementById('select-mes').value;
        const{data:p}=await _supabase.from('producao').select('*,usuarios(*)').gte('data_referencia',mes+'-01').lte('data_referencia',mes+'-31').order('data_referencia',{ascending:false});
        const{data:m}=await _supabase.from('metas').select('*');
        dadosGlobais=p||[]; metasGlobais=m||[]; alternarVisao();
    }
    function getWeek(d){ const date=new Date(d+'T12:00:00'); const first=new Date(date.getFullYear(),date.getMonth(),1); return Math.ceil((date.getDate()+first.getDay())/7); }
    function alternarVisao(){
        const v=document.getElementById('view-selector').value; let f=[], t='';
        if(v==='dia'){ const d=document.getElementById('select-dia').value; f=dadosGlobais.filter(x=>x.data_referencia===d); t='Dia: '+d.split('-').reverse().join('/'); }
        else if(v==='semana'){ const s=parseInt(document.getElementById('select-semana').value); f=dadosGlobais.filter(x=>getWeek(x.data_referencia)===s); t='Semana '+s; }
        else { f=dadosGlobais; t='M√™s'; }
        
        let stats={}; f.forEach(x=>{ if(!x.usuarios)return; const u=x.usuario_id; if(!stats[u]) stats[u]={n:x.usuarios.nome,q:0,fifo:0,gt:0,gp:0,fc:0}; stats[u].q+=x.quantidade; stats[u].fifo+=x.fifo; stats[u].gt+=x.gradual_total; stats[u].gp+=x.gradual_parcial; stats[u].fc+=x.perfil_fc; });
        const arr=Object.values(stats).sort((a,b)=>b.q-a.q);
        
        const tot=arr.reduce((a,b)=>a+b.q,0); document.getElementById('p-total').innerText=tot; document.getElementById('p-headcount').innerText=arr.length; document.getElementById('p-media').innerText=arr.length?Math.round(tot/arr.length):0; document.getElementById('panel-titulo').innerText=t;
        
        let h=''; arr.forEach(x=>{ h+=`<tr><td>${x.n}</td><td style="font-weight:700;color:var(--primary)">${x.q}</td><td>${x.fifo}</td><td>${x.gt}</td><td>${x.gp}</td><td>${x.fc}</td><td>-</td><td>-</td></tr>`; });
        document.getElementById('tabela-corpo').innerHTML=h||'<tr><td colspan="8">Sem dados</td></tr>';
    }
    async function importarArquivos(){ 
        const fs=document.getElementById('excel-files').files; let l={s:0,d:0};
        for(let f of fs){
            const n=f.name.replace('.xlsx',''); if(!/^\d{8}$/.test(n))continue;
            const dr=`${n.substring(4,8)}-${n.substring(2,4)}-${n.substring(0,2)}`;
            const b=await f.arrayBuffer(); const wb=XLSX.read(b,{type:'array'}); const j=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            for(let r of j){
                if(!r.id_assistente)continue;
                const{data:e}=await _supabase.from('producao').select('id').eq('usuario_id',r.id_assistente).eq('data_referencia',dr).maybeSingle();
                if(e)l.d++; else{ await _supabase.from('producao').insert({usuario_id:r.id_assistente,fifo:r.documentos_validados_fifo||0,gradual_total:r.documentos_validados_gradual_total||0,gradual_parcial:r.documentos_validados_gradual_parcial||0,perfil_fc:r.documentos_validados_perfil_fc||0,quantidade:r.documentos_validados||0,data_referencia:dr}); l.s++; }
            }
        }
        document.getElementById('log-content').innerText=`Sucesso: ${l.s} | Duplicados: ${l.d}`; document.getElementById('import-log').style.display='block'; carregarDados();
    }
    ajustarSeletores();
</script>
</body>
</html>
