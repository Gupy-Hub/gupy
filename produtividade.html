<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Produtividade - Gupy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #e11d48; --clt: #3b82f6; --pj: #8b5cf6; --success: #059669; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; background: var(--primary); }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-item { background: white; padding: 15px; border-radius: 10px; border-top: 4px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-geral { border-top-color: var(--primary); }
        .kpi-clt { border-top-color: var(--clt); }
        .kpi-pj { border-top-color: var(--pj); }
        .summary-label { font-size: 0.7rem; color: #64748b; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .summary-value { font-size: 1.4rem; font-weight: 800; }

        .table-container { overflow-x: auto; background: white; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 1200px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
        tr:hover { background-color: #f8fafc; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        
        input[type="month"], input[type="file"] { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0; font-size: 1.3rem;">üìä DashBoard Mensal de Produtividade</h1>
        <p style="margin:4px 0 0; color: #64748b; font-size: 0.8rem;">An√°lise Individual e por Contrato (CLT/PJ)</p>
    </div>
    <button class="btn" onclick="location.href='gestao.html'" style="background:#64748b;">‚öôÔ∏è Voltar √† Gest√£o</button>
</div>

<div class="card">
    <div style="display:flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 15px;">
        <div>
            <label style="display:block; font-size: 0.8rem; margin-bottom: 5px;">Importar Planilha (DDMMAAAA.xlsx)</label>
            <input type="file" id="excel-file" accept=".xlsx">
            <button class="btn" onclick="processarExcel()">Subir Dados</button>
        </div>
        <div>
            <label style="display:block; font-size: 0.8rem; margin-bottom: 5px;">M√™s do Relat√≥rio</label>
            <input type="month" id="filtro-mes" onchange="carregarDados()">
        </div>
    </div>
</div>

<div class="summary-grid">
    <div class="summary-item kpi-geral">
        <div class="summary-label">M√©dia Di√°ria Geral (Time)</div>
        <div class="summary-value" id="kpi-media-geral">0</div>
    </div>
    <div class="summary-item kpi-clt">
        <div class="summary-label">Total Valida√ß√£o Di√°ria CLT</div>
        <div class="summary-value" id="kpi-total-clt">0</div>
    </div>
    <div class="summary-item kpi-clt">
        <div class="summary-label">M√©dia Di√°ria CLT</div>
        <div class="summary-value" id="kpi-media-clt">0</div>
    </div>
    <div class="summary-item kpi-pj">
        <div class="summary-label">Total Valida√ß√£o Di√°ria PJ</div>
        <div class="summary-value" id="kpi-total-pj">0</div>
    </div>
    <div class="summary-item kpi-pj">
        <div class="summary-label">M√©dia Di√°ria PJ</div>
        <div class="summary-value" id="kpi-media-pj">0</div>
    </div>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Assistente (Contrato)</th>
                    <th>FIFO</th>
                    <th>Grad. Total</th>
                    <th>Grad. Parcial</th>
                    <th>Perfil FC</th>
                    <th>Total Dia</th>
                    <th>Semana</th>
                    <th>Total M√™s</th>
                    <th>M√©dia Mensal</th>
                    <th>Ating.</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                <tr><td colspan="11" style="text-align:center; padding:30px;">Carregando relat√≥rio...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    document.getElementById('filtro-mes').value = new Date().toISOString().substring(0, 7);

    async function processarExcel() {
        const file = document.getElementById('excel-file').files[0];
        if(!file) return alert("Selecione o arquivo!");
        const fileName = file.name.replace('.xlsx', '');
        const dataRef = `${fileName.substring(4,8)}-${fileName.substring(2,4)}-${fileName.substring(0,2)}`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const inserts = json.map(r => ({
                usuario_id: r.id_assistente,
                fifo: Number(r.documentos_validados_fifo || 0),
                gradual_total: Number(r.documentos_validados_gradual_total || 0),
                gradual_parcial: Number(r.documentos_validados_gradual_parcial || 0),
                perfil_fc: Number(r.documentos_validados_perfil_fc || 0),
                quantidade: Number(r.documentos_validados || 0),
                data_referencia: dataRef,
                nome_arquivo: file.name
            })).filter(x => x.usuario_id);

            const { error } = await _supabase.from('producao').insert(inserts);
            if(error) alert("Erro ou data j√° importada."); else { alert("Sucesso!"); carregarDados(); }
        };
        reader.readAsArrayBuffer(file);
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    async function carregarDados() {
        const mesAno = document.getElementById('filtro-mes').value;
        const { data: pData } = await _supabase.from('producao').select('*, usuarios(nome, contrato)')
            .gte('data_referencia', `${mesAno}-01`).lte('data_referencia', `${mesAno}-31`).order('data_referencia');

        if(!pData || pData.length === 0) {
            document.getElementById('tabela-corpo').innerHTML = '<tr><td colspan="11" style="text-align:center;">Sem dados.</td></tr>';
            return;
        }

        const { data: mData } = await _supabase.from('metas').select('*');

        let stats = {}; // Individuais
        let kpi = { totalG:0, dG:new Set(), totalC:0, dC:new Set(), totalP:0, dP:new Set() };

        // 1. Calcular Acumulados
        pData.forEach(p => {
            const uid = p.usuario_id;
            const qtd = Number(p.quantidade);
            const data = p.data_referencia;
            const week = getWeekNumber(new Date(data));
            const isCLT = (p.usuarios?.contrato || 'PJ').toUpperCase().includes('CLT');

            if(!stats[uid]) stats[uid] = { mes:0, dias:0, semanas:{} };
            stats[uid].mes += qtd;
            stats[uid].dias += 1;
            stats[uid].semanas[week] = (stats[uid].semanas[week] || 0) + qtd;

            kpi.totalG += qtd; kpi.dG.add(data);
            if(isCLT) { kpi.totalC += qtd; kpi.dC.add(data); } else { kpi.totalP += qtd; kpi.dP.add(data); }
        });

        // 2. Renderizar Tabela
        const tbody = document.getElementById('tabela-corpo');
        tbody.innerHTML = pData.map(p => {
            const uid = p.usuario_id;
            const week = getWeekNumber(new Date(p.data_referencia));
            const metaObj = mData ? mData.filter(m => m.usuario_id == uid && m.data_inicio <= p.data_referencia).sort((a,b)=>b.id-a.id)[0] : null;
            const metaVal = metaObj ? Number(metaObj.valor_meta) : 0;
            const ating = metaVal > 0 ? ((p.quantidade / metaVal) * 100).toFixed(0) : 0;

            return `<tr>
                <td>${new Date(p.data_referencia).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td>
                <td><strong>${p.usuarios?.nome || 'ID:'+uid}</strong> <span style="font-size:0.65rem; color:#64748b;">(${p.usuarios?.contrato || 'PJ'})</span></td>
                <td>${p.fifo}</td>
                <td>${p.gradual_total}</td>
                <td>${p.gradual_parcial}</td>
                <td>${p.perfil_fc}</td>
                <td><strong>${p.quantidade}</strong></td>
                <td><span style="color:#64748b">${stats[uid].semanas[week]}</span></td>
                <td>${stats[uid].mes}</td>
                <td>${(stats[uid].mes / stats[uid].dias).toFixed(0)}</td>
                <td><span class="badge ${ating >= 100 ? 'bg-green' : 'bg-red'}">${ating}%</span></td>
            </tr>`;
        }).join('');

        // 3. Atualizar Cards KPIs
        document.getElementById('kpi-media-geral').innerText = (kpi.totalG / (kpi.dG.size || 1)).toFixed(0);
        document.getElementById('kpi-total-clt').innerText = kpi.totalC.toLocaleString('pt-BR');
        document.getElementById('kpi-media-clt').innerText = (kpi.totalC / (kpi.dC.size || 1)).toFixed(0);
        document.getElementById('kpi-total-pj').innerText = kpi.totalP.toLocaleString('pt-BR');
        document.getElementById('kpi-media-pj').innerText = (kpi.totalP / (kpi.dP.size || 1)).toFixed(0);
    }
    carregarDados();
</script>
</body>
</html>
