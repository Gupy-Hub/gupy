<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha √Årea</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- IDENTITY GUPY STYLE --- */
        :root { 
            --primary: #0045d0; --accent: #2662ea; --nav: #0d1b2a;
            --success: #00d09e; --danger: #ef4444; --warning: #f59e0b;
            --bg: #f3f5f8; --card: #ffffff; --border: #e2e8f0;
            --text-main: #1f2937; --text-muted: #64748b;
            --row-weekend: #fefce8; /* Amarelo bem claro para FDS */
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-top: 80px; color: var(--text-main); }

        /* NAVBAR */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: var(--nav); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .nav-left { display: flex; align-items: center; gap: 40px; }
        .brand .big { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; color: white; }
        .brand .big span { color: var(--accent); }
        .nav-links { display: flex; gap: 30px; }
        .nav-item { color: #94a3b8; text-decoration: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: 0.3s; padding-bottom: 23px; border-bottom: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { color: white; border-bottom-color: var(--accent); }
        .user-area { text-align: right; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 20px; }
        .user-name { font-weight: 600; font-size: 0.85rem; color: white; }
        .logout-btn { color: #fca5a5; font-size: 0.7rem; cursor: pointer; font-weight: 600; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }

        /* HEADER BOAS VINDAS */
        .welcome-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; }
        .welcome-title h1 { font-size: 1.8rem; color: var(--nav); margin: 0; letter-spacing: -0.5px; }
        .welcome-title p { color: var(--text-muted); margin: 5px 0 0 0; font-size: 0.95rem; }
        .date-control input { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: 'Inter'; font-size: 0.9rem; outline: none; }

        /* KPI GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--nav); }
        .stat-sub { font-size: 0.85rem; margin-top: 5px; color: var(--text-muted); }

        /* AREA GRAFICO */
        .chart-section { background: var(--card); padding: 25px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px; height: 300px; }
        .chart-title { font-weight: 700; color: var(--nav); margin-bottom: 15px; }

        /* TABELA DI√ÅRIO DE BORDO */
        .log-section { background: var(--card); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .log-header { padding: 20px; border-bottom: 1px solid var(--border); background: #f8fafc; display: flex; justify-content: space-between; align-items: center; }
        .log-header h3 { margin: 0; color: var(--nav); font-size: 1.1rem; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { padding: 15px; text-align: left; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); background: #fff; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        
        /* Estilos Espec√≠ficos da Tabela Excel */
        .col-date { font-weight: 600; color: var(--nav); width: 120px; }
        .col-prod { font-weight: 700; color: var(--primary); width: 100px; text-align: center; }
        .col-meta { width: 100px; text-align: center; }
        .col-ausencia { color: var(--warning); font-weight: 500; width: 150px; }
        .col-obs { color: var(--text-muted); font-style: italic; font-size: 0.85rem; }

        .row-weekend { background-color: var(--row-weekend); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: white; display: inline-block; min-width: 60px; text-align: center; }
        .bg-sim { background: var(--success); }
        .bg-nao { background: var(--danger); }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <div class="brand" onclick="window.location.href='produtividade.html'">
            <div class="big">PRODUTIVIDADE<span>.</span></div>
        </div>
        <div class="nav-links">
            <a href="minha_area.html" class="nav-item active">Minha √Årea</a>
            <a href="gestao.html" class="nav-item">Gest√£o</a>
            <a href="produtividade.html" class="nav-item">Produtividade</a>
            <a href="performance.html" class="nav-item">Performance</a>
            <a href="consolidado.html" class="nav-item">Consolidado</a>
        </div>
    </div>
    <div class="user-area">
        <span id="user-display" class="user-name">Carregando...</span>
        <span class="logout-btn" onclick="logout()">Sair</span>
    </div>
</nav>

<div class="container">
    
    <div class="welcome-header">
        <div class="welcome-title">
            <h1 id="welcome-msg">Ol√°, Assistente</h1>
            <p>Acompanhe sua evolu√ß√£o di√°ria e metas.</p>
        </div>
        <div class="date-control">
            <input type="month" id="month-selector" onchange="carregarMeusDados()">
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card" style="border-top: 4px solid var(--primary);">
            <div class="stat-label">Produ√ß√£o Mensal</div>
            <div class="stat-value" id="kpi-total">0</div>
            <div class="stat-sub">Documentos validados</div>
        </div>
        <div class="stat-card" style="border-top: 4px solid var(--accent);">
            <div class="stat-label">M√©dia Di√°ria</div>
            <div class="stat-value" id="kpi-media">0</div>
            <div class="stat-sub">Nos dias trabalhados</div>
        </div>
        <div class="stat-card" style="border-top: 4px solid var(--success);">
            <div class="stat-label">Melhor Dia</div>
            <div class="stat-value" id="kpi-best">0</div>
            <div class="stat-sub" id="kpi-best-date">-</div>
        </div>
        <div class="stat-card" style="border-top: 4px solid var(--warning);">
            <div class="stat-label">Atingimento Meta</div>
            <div class="stat-value" id="kpi-hitrate">0%</div>
            <div class="stat-sub" id="kpi-meta-detail">Meta base: 650</div>
        </div>
    </div>

    <div class="chart-section">
        <div class="chart-title">üìà Minha Evolu√ß√£o no M√™s</div>
        <div style="height: 230px; position: relative;">
            <canvas id="evolutionChart"></canvas>
        </div>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3>Di√°rio de Valida√ß√µes</h3>
            <span style="font-size:0.8rem; color:var(--text-muted)">Visualiza√ß√£o detalhada</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th style="text-align:center">N¬∫ Valida√ß√µes</th>
                    <th style="text-align:center">Meta Atingida</th>
                    <th>Aus√™ncias/Feriados</th>
                    <th>Anota√ß√£o/Obs do Time</th>
                </tr>
            </thead>
            <tbody id="log-body">
                </tbody>
        </table>
    </div>

</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // Valida√ß√£o de Sess√£o
    const sessao = JSON.parse(localStorage.getItem('usuario'));
    if(!sessao) window.location.href = 'index.html';
    
    // Configura√ß√£o UI
    document.getElementById('user-display').innerText = sessao.nome;
    document.getElementById('welcome-msg').innerText = `Ol√°, ${sessao.nome.split(' ')[0]}`;
    
    // Data Inicial (M√™s Atual)
    const hoje = new Date();
    document.getElementById('month-selector').value = hoje.toISOString().substring(0, 7);

    let myChart = null;

    function logout() { localStorage.removeItem('usuario'); window.location.href = 'index.html'; }

    async function carregarMeusDados() {
        const mesStr = document.getElementById('month-selector').value;
        const [ano, mes] = mesStr.split('-');
        
        // 1. Busca Produ√ß√£o do Usu√°rio no M√™s
        const { data: producao } = await _supabase.from('producao')
            .select('*')
            .eq('usuario_id', sessao.id)
            .gte('data_referencia', `${mesStr}-01`)
            .lte('data_referencia', `${mesStr}-31`)
            .order('data_referencia');

        // 2. Busca Meta Vigente
        const { data: metas } = await _supabase.from('metas')
            .select('*')
            .eq('usuario_id', sessao.id)
            .order('data_inicio', { ascending: false });
        
        const metaAtual = metas.find(m => m.data_inicio <= `${mesStr}-31`)?.valor_meta || 650;
        document.getElementById('kpi-meta-detail').innerText = `Meta base: ${metaAtual}`;

        renderizarKPIs(producao || [], metaAtual);
        renderizarLog(producao || [], metaAtual, parseInt(ano), parseInt(mes));
    }

    function renderizarKPIs(dados, meta) {
        if(dados.length === 0) {
            document.getElementById('kpi-total').innerText = '0';
            document.getElementById('kpi-media').innerText = '0';
            document.getElementById('kpi-hitrate').innerText = '0%';
            return;
        }

        const total = dados.reduce((a,b) => a + b.quantidade, 0);
        const dias = dados.length;
        const media = (total / dias).toFixed(0);
        const best = dados.reduce((p,c) => p.quantidade > c.quantidade ? p : c);
        
        const diasMeta = dados.filter(d => d.quantidade >= meta).length;
        const hitRate = ((diasMeta / dias) * 100).toFixed(0);

        document.getElementById('kpi-total').innerText = total.toLocaleString();
        document.getElementById('kpi-media').innerText = media;
        document.getElementById('kpi-best').innerText = best.quantidade;
        document.getElementById('kpi-best-date').innerText = best.data_referencia.split('-').reverse().join('/');
        
        const elHit = document.getElementById('kpi-hitrate');
        elHit.innerText = `${hitRate}%`;
        elHit.style.color = hitRate >= 100 ? 'var(--success)' : (hitRate >= 80 ? 'var(--warning)' : 'var(--danger)');
    }

    function renderizarLog(dados, meta, ano, mes) {
        // Gerar todos os dias do m√™s
        const daysInMonth = new Date(ano, mes, 0).getDate();
        const tbody = document.getElementById('log-body');
        let html = '';
        
        // Arrays para o Gr√°fico
        let chartLabels = [];
        let chartData = [];
        let chartMeta = [];

        // Mapa de dados para acesso r√°pido
        const dataMap = {};
        dados.forEach(d => dataMap[d.data_referencia] = d);

        for(let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(ano, mes - 1, d);
            const dateStr = dateObj.toISOString().split('T')[0];
            const diaSemana = dateObj.getDay(); // 0=Dom, 6=Sab
            const diaFormatado = dateStr.split('-').reverse().join('/');
            
            const isWeekend = diaSemana === 0 || diaSemana === 6;
            const registro = dataMap[dateStr];
            
            // Dados para o gr√°fico (s√≥ dias √∫teis ou com produ√ß√£o)
            if(!isWeekend || registro) {
                chartLabels.push(d);
                chartData.push(registro ? registro.quantidade : 0);
                chartMeta.push(meta);
            }

            // L√≥gica da Tabela
            let statusBadge = '';
            let ausenciaText = '';
            let qtdText = '';
            let rowClass = '';

            if (isWeekend) {
                rowClass = 'row-weekend';
                ausenciaText = diaSemana === 0 ? 'Domingo' : 'S√°bado';
            }

            if (registro) {
                qtdText = registro.quantidade.toLocaleString();
                const atingiu = registro.quantidade >= meta;
                statusBadge = atingiu 
                    ? `<span class="badge bg-sim">Sim</span>` 
                    : `<span class="badge bg-nao">N√£o</span>`;
                // Se trabalhou no FDS, remove texto de aus√™ncia
                if(isWeekend) ausenciaText = `<span style="color:var(--success); font-weight:bold;">Plant√£o/Extra</span>`;
            } else if (!isWeekend) {
                // Dia de semana sem produ√ß√£o
                qtdText = '-';
                statusBadge = '-';
                // Aqui poderia entrar l√≥gica de Feriado se tiv√©ssemos uma tabela de feriados
                // Por enquanto fica em branco ou assume falta/feriado
            }

            html += `
                <tr class="${rowClass}">
                    <td class="col-date">${diaFormatado}</td>
                    <td class="col-prod">${qtdText}</td>
                    <td class="col-meta">${statusBadge}</td>
                    <td class="col-ausencia">${ausenciaText}</td>
                    <td class="col-obs"></td> 
                </tr>
            `;
        }
        
        tbody.innerHTML = html;
        atualizarGrafico(chartLabels, chartData, chartMeta);
    }

    function atualizarGrafico(labels, data, metas) {
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Minha Produ√ß√£o',
                        data: data,
                        borderColor: '#2662ea',
                        backgroundColor: 'rgba(38, 98, 234, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4
                    },
                    {
                        label: 'Meta',
                        data: metas,
                        borderColor: '#ef4444',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        borderWidth: 1.5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    carregarMeusDados();
</script>
</body>
</html>
