<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Minha 츼rea</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/logo.css">
    
    <style>
        /* Estilos espec칤ficos da 치rea de inputs manuais */
        .input-qty{width:60px;text-align:center;border:1px solid #cbd5e1;border-radius:4px;padding:4px;font-weight:600;}
        .input-obs{width:100%;border:1px solid #e2e8f0;padding:4px;border-radius:4px;font-size:0.8rem;}
        .input-feedback{border-color:#fed7aa;background:#fff7ed;}
        .input-divergent{border-color:var(--danger);background:#fee2e2;color:var(--danger);}
    </style>
</head>
<body>
<div class="container">
    <div class="welcome-header" style="margin-bottom:20px;">
        <h1 id="welcome-msg" style="margin:0; color:var(--nav);">Ol치</h1>
    </div>

    <div class="top-controls">
        <div id="manager-controls" class="hidden" style="border-right:1px solid #ddd;padding-right:15px;margin-right:15px;flex:1.5;">
            <label style="color:var(--primary)">Colaborador (Vis칚o Gestora)</label>
            <select id="user-selector" onchange="load()"></select>
        </div>
        <div class="control-group">
            <label>Tipo</label>
            <select id="period-type" onchange="upd()"><option value="mes">Mensal</option><option value="ano">Anual</option></select>
        </div>
        <div class="control-group">
            <label>Ano</label>
            <select id="year-selector" onchange="upd()"></select>
        </div>
        <div class="control-group" style="flex:1.2">
            <label>Per칤odo</label>
            <select id="period-value" onchange="load()"></select>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Sistema</div><div class="stat-value" id="kpi-sys">0</div></div>
        <div class="stat-card"><div class="stat-label">Manual</div><div class="stat-value" id="kpi-man">0</div></div>
        <div class="stat-card"><div class="stat-label">% Meta Atingida</div><div class="stat-value" id="kpi-hit">0%</div></div>
    </div>

    <div class="chart-section" style="height:300px;margin-bottom:20px; background:var(--card); padding:15px; border-radius:8px; border:1px solid var(--border);">
        <canvas id="chart"></canvas>
    </div>

    <div class="log-section">
        <div class="log-header"><h3>Di치rio de Produ칞칚o</h3><span>游 = Validado/Travado</span></div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th style="text-align:center">Sis</th>
                        <th style="text-align:center">Man</th>
                        <th style="text-align:center">Meta</th>
                        <th style="text-align:center">Status</th>
                        <th style="width:25%">Anota칞칫es</th>
                        <th style="width:25%;color:var(--primary)">Feedback Gest칚o</th>
                    </tr>
                </thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/logo.js"></script>
<script src="assets/js/layout.js"></script>

<script>
    let chart=null, uid=SESSAO_ATUAL.id; 
    const isMgr = SESSAO_ATUAL.funcao==='Gestora';
    
    document.getElementById('welcome-msg').innerText=`Ol치, ${SESSAO_ATUAL.nome.split(' ')[0]}`;
    
    document.addEventListener('DOMContentLoaded', async ()=>{
        const y=document.getElementById('year-selector'), cy=new Date().getFullYear(); 
        y.innerHTML=''; 
        for(let i=cy; i>=2024; i--) y.innerHTML+=`<option value="${i}">${i}</option>`;
        
        if(isMgr){
            document.getElementById('manager-controls').classList.remove('hidden');
            const {data}=await _supabase.from('usuarios').select('*').order('nome');
            const sel=document.getElementById('user-selector');
            data.filter(u=>u.funcao!=='Gestora').forEach(u=>sel.innerHTML+=`<option value="${u.id}">${u.nome}</option>`);
            if(data.length) uid=data[0].id;
        }
        upd();
    });

    function upd(){
        const t=document.getElementById('period-type').value, v=document.getElementById('period-value'); v.innerHTML='';
        if(t==='mes') ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].forEach((m,i)=>v.innerHTML+=`<option value="${i+1}" ${i===new Date().getMonth()?'selected':''}>${m}</option>`);
        else v.innerHTML='<option value="1">Ano Completo</option>';
        load();
    }

    async function load(){
        if(isMgr) uid=document.getElementById('user-selector').value;
        const t=document.getElementById('period-type').value, y=document.getElementById('year-selector').value, val=parseInt(document.getElementById('period-value').value);
        let s='', e='';
        
        if(t==='mes'){ s=`${y}-${val.toString().padStart(2,'0')}-01`; e=`${y}-${val.toString().padStart(2,'0')}-${new Date(y,val,0).getDate()}`; }
        else{ s=`${y}-01-01`; e=`${y}-12-31`; }

        const {data:p}=await _supabase.from('producao').select('*').eq('usuario_id',uid).gte('data_referencia',s).lte('data_referencia',e).order('data_referencia');
        const {data:m}=await _supabase.from('metas').select('*').eq('usuario_id',uid).order('data_inicio',{ascending:false});
        const meta=m.find(x=>x.data_inicio<=e)?.valor_meta||650;
        
        render(p||[], meta, s, e);
    }

    function render(d, meta, sStr, eStr){
        const map={}; d.forEach(x=>map[x.data_referencia]=x);
        let h='', s=new Date(sStr), e=new Date(eStr); s.setHours(12,0,0,0); e.setHours(12,0,0,0);
        let l=[], ds=[], dm=[]; let sysT=0, manT=0, hits=0, days=0;

        for(let dt=new Date(s); dt<=e; dt.setDate(dt.getDate()+1)){
            const dStr=dt.toISOString().split('T')[0], w=dt.getDay(), isW=w===0||w===6, r=map[dStr]||{};
            const qS=r.quantidade||0, qM=r.quantidade_manual, obs=r.observacao||'', obsG=r.observacao_gestora||'';
            
            // L칩gica de Travamento: Se tem feedback da gest칚o e n칚o sou gestora, trava.
            const lock = !isMgr && (obsG && obsG.trim()!=='');
            const dQ = isMgr?'disabled':(lock?'disabled':''), dO=dQ, dG=isMgr?'':'disabled';
            
            if(!isW||qS>0){ l.push(dStr.substring(5)); ds.push(qS); dm.push(meta); }
            if(qS>0){ sysT+=qS; days++; if(qS>=meta)hits++; }
            if(qM) manT+=qM;

            let stC='bg-none', stT='-'; if(qS>0){ if(qS>=meta){stC='bg-sim';stT='Sim'}else{stC='bg-nao';stT='N칚o'} }
            let mVal=(qM!==null&&qM!==undefined&&qM!==0)?qM:'';
            
            h+=`<tr class="${isW?'row-weekend':''}">
                <td>${dStr.split('-').reverse().join('/')}</td>
                <td style="text-align:center">${qS||'-'}</td>
                <td style="text-align:center"><input type="number" class="input-qty ${mVal&&parseInt(mVal)!==qS?'input-divergent':''}" value="${mVal}" onchange="save(this,'${dStr}','quantidade_manual')" ${dQ}></td>
                <td style="text-align:center">${meta}</td>
                <td style="text-align:center"><span class="badge ${stC}">${stT}</span></td>
                <td><div style="display:flex;align-items:center;"><input type="text" class="input-obs" value="${obs}" onchange="save(this,'${dStr}','observacao')" ${dO}><span>${lock?'游':''}</span></div></td>
                <td><input type="text" class="input-obs input-feedback" value="${obsG}" onchange="save(this,'${dStr}','observacao_gestora')" ${dG}></td>
            </tr>`;
        }
        document.getElementById('log-body').innerHTML=h;
        document.getElementById('kpi-sys').innerText=sysT.toLocaleString(); 
        document.getElementById('kpi-man').innerText=manT.toLocaleString(); 
        document.getElementById('kpi-hit').innerText=(days>0?Math.round((hits/days)*100):0)+'%';
        
        if(chart)chart.destroy();
        chart=new Chart(document.getElementById('chart'),{
            type:'line',
            data:{
                labels:l,
                datasets:[
                    {label:'Sis',data:ds,borderColor:'#2662ea',backgroundColor:'rgba(38,98,234,0.1)',fill:true},
                    {label:'Meta',data:dm,borderColor:'#ef4444',borderDash:[5,5],pointRadius:0}
                ]
            },
            options:{responsive:true,maintainAspectRatio:false}
        });
    }

    async function save(e,d,f){
        if(isMgr && f!=='observacao_gestora')return; 
        if(!isMgr && f==='observacao_gestora')return;
        
        e.style.borderColor='#fbbf24';
        const {data:x}=await _supabase.from('producao').select('id').eq('usuario_id',uid).eq('data_referencia',d).maybeSingle();
        
        if(x) await _supabase.from('producao').update({[f]:e.value}).eq('id',x.id);
        else await _supabase.from('producao').insert({usuario_id:uid,data_referencia:d,[f]:e.value,quantidade:0});
        
        e.style.borderColor='#00d09e'; 
        setTimeout(()=>e.style.borderColor='',500);
        
        if(f==='observacao_gestora') load(); // Recarrega para aplicar travamento se necess치rio
    }
</script>
</body>
</html>
