<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Minha √Årea</title>
    <link rel="icon" href="assets/img/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .input-qty { width: 60px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; font-weight: 600; }
        .input-qty:disabled { background: #e2e8f0; cursor: not-allowed; color: #94a3b8; }
        
        .input-obs { width: 100%; border: 1px solid #e2e8f0; padding: 4px; border-radius: 4px; font-size: 0.8rem; }
        .input-obs:disabled { background: #e2e8f0; cursor: not-allowed; color: #94a3b8; }
        
        .input-feedback { border-color: #fed7aa; background: #fff7ed; }
        .input-feedback:focus { background: #fff; border-color: var(--warning); }
        .input-feedback:disabled { background: #f1f5f9; border-color: #e2e8f0; }

        .input-divergent { border-color: var(--danger); background: #fee2e2; color: var(--danger); }
        
        .row-weekend { background-color: var(--row-weekend); }
        .lock-icon { margin-left: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="welcome-header">
        <h1 id="welcome-msg">Ol√°</h1>
        <p>Di√°rio de Valida√ß√µes</p>
    </div>

    <div class="top-controls">
        <div id="manager-controls" class="hidden" style="border-right:1px solid #ddd; padding-right:15px; margin-right:15px; flex:1.5;">
            <label style="color:var(--primary)">Visualizar Colaborador</label>
            <select id="user-selector" onchange="carregarMeusDados()"></select>
        </div>

        <div class="control-group">
            <label>Tipo</label>
            <select id="period-type" onchange="atualizarOpcoesPeriodo()">
                <option value="mes">Mensal</option>
                <option value="ano">Anual</option>
            </select>
        </div>
        <div class="control-group">
            <label>Ano</label>
            <select id="year-selector" onchange="atualizarOpcoesPeriodo()"></select>
        </div>
        <div class="control-group" style="flex:1.2">
            <label>Per√≠odo</label>
            <select id="period-value" onchange="carregarMeusDados()"></select>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card" style="border-top:4px solid var(--primary)">
            <div class="stat-label">Total Sistema</div>
            <div class="stat-value" id="kpi-sys">0</div>
        </div>
        <div class="stat-card" style="border-top:4px solid var(--accent)">
            <div class="stat-label">Total Manual</div>
            <div class="stat-value" id="kpi-man">0</div>
        </div>
        <div class="stat-card" style="border-top:4px solid var(--warning)">
            <div class="stat-label">Atingimento Meta</div>
            <div class="stat-value" id="kpi-hit">0%</div>
            <div class="stat-sub" id="meta-ref">Baseado no Sistema</div>
        </div>
    </div>

    <div class="chart-section" style="height:250px; margin-bottom:20px;">
        <canvas id="chart"></canvas>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3>Di√°rio de Confer√™ncia</h3>
            <span style="font-size:0.75rem; color:var(--text-muted)">üîí = Travado ap√≥s feedback</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th style="text-align:center">Qtd. Sistema</th>
                    <th style="text-align:center">Minha Contagem</th>
                    <th style="text-align:center">Meta</th>
                    <th style="text-align:center">Status</th>
                    <th style="width:25%">Minhas Anota√ß√µes</th>
                    <th style="width:25%; color:var(--primary)">Feedback Gest√£o</th>
                </tr>
            </thead>
            <tbody id="log-body"></tbody>
        </table>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>

<script>
    let myChart = null;
    let targetUserId = SESSAO_ATUAL.id;
    const isMgr = SESSAO_ATUAL.funcao === 'Gestora';

    document.getElementById('welcome-msg').innerText = `Ol√°, ${SESSAO_ATUAL.nome.split(' ')[0]}`;

    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Carrega Anos
        const yearSel = document.getElementById('year-selector');
        const cy = new Date().getFullYear();
        yearSel.innerHTML = '';
        for(let i=cy; i>=2024; i--) yearSel.innerHTML+=`<option value="${i}">${i}</option>`;

        // 2. Se for Gestora, carrega lista de assistentes
        if(isMgr) {
            document.getElementById('manager-controls').classList.remove('hidden');
            const { data } = await _supabase.from('usuarios').select('*').order('nome');
            const sel = document.getElementById('user-selector');
            const assistentes = data.filter(u => u.funcao !== 'Gestora' && u.funcao !== 'Auditora');
            
            assistentes.forEach(u => sel.innerHTML += `<option value="${u.id}">${u.nome}</option>`);
            
            if(assistentes.length > 0) targetUserId = assistentes[0].id;
        }

        // 3. Carrega op√ß√µes de per√≠odo e dados
        atualizarOpcoesPeriodo();
    });

    function atualizarOpcoesPeriodo() {
        const type = document.getElementById('period-type').value;
        const valSel = document.getElementById('period-value');
        valSel.innerHTML = '';
        
        if(type === 'mes') {
            ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'].forEach((m,i)=>{
                valSel.innerHTML += `<option value="${i+1}" ${i===new Date().getMonth()?'selected':''}>${m}</option>`;
            });
        } else {
            valSel.innerHTML = '<option value="1">Ano Completo</option>';
        }
        carregarMeusDados();
    }

    async function carregarMeusDados() {
        if(isMgr) targetUserId = document.getElementById('user-selector').value;
        
        const type = document.getElementById('period-type').value;
        const year = document.getElementById('year-selector').value;
        const val = parseInt(document.getElementById('period-value').value);
        
        let start='', end='';
        if(type === 'mes') {
            start = `${year}-${val.toString().padStart(2,'0')}-01`;
            end = `${year}-${val.toString().padStart(2,'0')}-${new Date(year, val, 0).getDate()}`;
        } else {
            start = `${year}-01-01`; end = `${year}-12-31`;
        }

        // Busca dados e metas
        const { data: prod } = await _supabase.from('producao').select('*').eq('usuario_id', targetUserId).gte('data_referencia', start).lte('data_referencia', end).order('data_referencia');
        const { data: metas } = await _supabase.from('metas').select('*').eq('usuario_id', targetUserId).order('data_inicio', {ascending:false});

        // Meta atual (baseada na data fim do periodo)
        const metaAtual = metas.find(m => m.data_inicio <= end)?.valor_meta || 650;
        document.getElementById('meta-ref').innerText = `Meta base: ${metaAtual}`;

        renderizarLog(prod || [], metaAtual, start, end);
        renderizarKPIs(prod || [], metaAtual);
    }

    function renderizarKPIs(dados, meta) {
        if(!dados.length) { ['kpi-sys','kpi-man','kpi-hit'].forEach(i=>document.getElementById(i).innerText='-'); return; }
        
        const sys = dados.reduce((a,b)=>a+(b.quantidade||0),0);
        const man = dados.reduce((a,b)=>a+(b.quantidade_manual||0),0);
        const dias = dados.filter(d=>d.quantidade>0).length;
        const hits = dados.filter(d=>d.quantidade>=meta).length;
        const rate = dias>0 ? Math.round((hits/dias)*100) : 0;

        document.getElementById('kpi-sys').innerText = sys.toLocaleString();
        document.getElementById('kpi-man').innerText = man.toLocaleString();
        document.getElementById('kpi-hit').innerText = rate + '%';
        
        if(sys !== man) document.getElementById('kpi-man').style.color = 'var(--danger)';
        else document.getElementById('kpi-man').style.color = 'var(--nav)';
    }

    function renderizarLog(dados, meta, startStr, endStr) {
        const tbody = document.getElementById('log-body');
        const map = {}; 
        dados.forEach(d => map[d.data_referencia] = d);

        let html = '';
        const start = new Date(startStr); const end = new Date(endStr);
        // Ajuste fuso horario simples
        start.setHours(12,0,0,0); end.setHours(12,0,0,0);

        let labels=[], dataSys=[], dataMeta=[];

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const diaSemana = d.getDay(); 
            const isWeekend = diaSemana === 0 || diaSemana === 6;
            const reg = map[dateStr] || {};
            
            const qtdSys = reg.quantidade || 0;
            const qtdMan = reg.quantidade_manual; // pode ser null
            const obs = reg.observacao || '';
            const obsGest = reg.observacao_gestora || '';
            
            // L√≥gica de Trava
            // Se tiver feedback da gestora, assistente n√£o edita mais.
            const isLocked = !isMgr && (obsGest && obsGest.trim() !== '');
            
            // Defines disabled states
            // Gestora: N√£o edita Qtd nem Obs Assistente. Edita apenas Feedback.
            // Assistente: Edita Qtd e Obs (se n√£o estiver travado). N√£o edita Feedback.
            const disQtd = isMgr ? 'disabled' : (isLocked ? 'disabled' : '');
            const disObs = isMgr ? 'disabled' : (isLocked ? 'disabled' : '');
            const disGest = isMgr ? '' : 'disabled';
            
            const lockIcon = isLocked ? 'üîí' : '';

            // Grafico
            if(!isWeekend || qtdSys>0) {
                labels.push(dateStr.split('-').reverse().join('/').substring(0,5));
                dataSys.push(qtdSys);
                dataMeta.push(meta);
            }

            let badge = '-', statusClass = 'bg-none';
            if(qtdSys > 0) {
                if(qtdSys >= meta) { badge='Sim'; statusClass='bg-sim'; }
                else { badge='N√£o'; statusClass='bg-nao'; }
            }

            let manVal = (qtdMan !== null && qtdMan !== undefined && qtdMan !== 0) ? qtdMan : '';
            let manClass = '';
            if(manVal !== '' && parseInt(manVal) !== qtdSys) manClass = 'input-divergent';

            html += `
            <tr class="${isWeekend?'row-weekend':''}">
                <td>${dateStr.split('-').reverse().join('/')}</td>
                <td style="text-align:center">${qtdSys>0?qtdSys.toLocaleString():'-'}</td>
                <td style="text-align:center">
                    <input type="number" class="input-qty ${manClass}" value="${manVal}" 
                    onchange="atualizarDiario(this, '${dateStr}', 'quantidade_manual')" ${disQtd}>
                </td>
                <td style="text-align:center">${meta}</td>
                <td style="text-align:center"><span class="badge ${statusClass}">${badge}</span></td>
                <td>
                    <div style="display:flex; align-items:center;">
                        <input type="text" class="input-obs" value="${obs}" 
                        onchange="atualizarDiario(this, '${dateStr}', 'observacao')" ${disObs}>
                        <span class="lock-icon">${lockIcon}</span>
                    </div>
                </td>
                <td>
                    <input type="text" class="input-obs input-feedback" value="${obsGest}" 
                    onchange="atualizarDiario(this, '${dateStr}', 'observacao_gestora')" ${disGest}>
                </td>
            </tr>`;
        }
        tbody.innerHTML = html;
        updateChart(labels, dataSys, dataMeta);
    }

    async function atualizarDiario(el, dateStr, campo) {
        // Valida√ß√£o extra de seguran√ßa
        if(isMgr && campo !== 'observacao_gestora') return;
        if(!isMgr && campo === 'observacao_gestora') return;

        el.style.borderColor = '#fbbf24'; // saving color

        const val = el.value;
        // Upsert logic
        const { data: existing } = await _supabase.from('producao').select('id').eq('usuario_id', targetUserId).eq('data_referencia', dateStr).maybeSingle();

        let error = null;
        if(existing) {
            const { error: e } = await _supabase.from('producao').update({ [campo]: val }).eq('id', existing.id);
            error = e;
        } else {
            const payload = { 
                usuario_id: targetUserId, data_referencia: dateStr, [campo]: val,
                quantidade: 0, fifo: 0, gradual_total: 0, gradual_parcial: 0, perfil_fc: 0
            };
            const { error: e } = await _supabase.from('producao').insert(payload);
            error = e;
        }

        if(error) { alert('Erro ao salvar'); el.style.borderColor = 'red'; }
        else {
            el.style.borderColor = '#00d09e';
            setTimeout(() => { 
                el.style.borderColor = ''; 
                // Se foi a gestora comentando, recarrega para aplicar o bloqueio visual para a assistente (se ela estivesse vendo em tempo real, mas aqui serve para limpar status)
                if(campo === 'observacao_gestora' || campo === 'quantidade_manual') carregarMeusDados();
            }, 500);
        }
    }

    function updateChart(lbl, dat, met) {
        const ctx = document.getElementById('chart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: lbl,
                datasets: [
                    { label: 'Sistema', data: dat, borderColor: '#2662ea', backgroundColor: 'rgba(38,98,234,0.1)', fill: true, tension:0.3 },
                    { label: 'Meta', data: met, borderColor: '#ef4444', borderDash:[5,5], pointRadius:0 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }
</script>
</body>
</html>
