<script>
    // 1. Verifica se já está logado
    // Se tiver sessão antiga ('usuario'), redireciona para o PAINEL novo
    if(localStorage.getItem('usuario') || localStorage.getItem('gupy_session')) {
        window.location.href = 'painel.html';
    }

    function handleEnter(e) { 
        if(e.key === 'Enter') fazerLogin(); 
    }

    async function fazerLogin() {
        const idVal = document.getElementById('login-id').value.trim();
        const passVal = document.getElementById('senha').value.trim();
        const btn = document.getElementById('btn-entrar');
        const msg = document.getElementById('error-msg');

        msg.style.display = 'none';
        
        if(!idVal || !passVal) { 
            msg.innerText = "Por favor, informe ID e Senha."; 
            msg.style.display = 'block'; 
            return; 
        }

        btn.disabled = true;
        btn.innerText = "Entrando...";

        try {
            // Consulta no Supabase
            const { data, error } = await _supabase
                .from('usuarios')
                .select('*')
                .eq('id', idVal)
                .eq('senha', passVal)
                .maybeSingle();

            if (error) throw error;

            if (data) {
                // Salva a sessão no formato antigo (para compatibilidade)
                localStorage.setItem('usuario', JSON.stringify(data));
                
                // MUDANÇA AQUI: Redireciona para o novo painel unificado
                window.location.href = 'painel.html';
            } else { 
                throw new Error("Não encontrado"); 
            }

        } catch (err) {
            console.error(err);
            msg.innerText = "Credenciais inválidas."; 
            msg.style.display = 'block';
            btn.disabled = false;
            btn.innerText = "Acessar Sistema";
        }
    }
</script>
