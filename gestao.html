<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o</title>
    <link rel="icon" href="assets/img/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .management-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .list-container { height: 400px; overflow-y: auto; }
        .list-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); align-items: center; }
        .list-item:hover { background: #f8fafc; }
        .role-tag { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; background: #e2e8f0; font-weight: 600; margin-left: 5px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal { background: white; width: 100%; max-width: 500px; border-radius: 12px; padding: 30px; }
        .btn-action { background: white; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>
<div class="container">
    <div class="top-controls"><div><h1 style="font-size:1.5rem;color:var(--nav);">Painel de Gest√£o</h1></div></div>
    <div class="management-grid">
        <div class="stat-card">
            <div class="log-header" style="background:transparent; padding-left:0;"><h3>üéØ Metas</h3></div>
            <div class="control-group"><label>Colaborador</label><select id="meta-user"></select></div>
            <div class="control-group" style="margin-top:10px;"><label>In√≠cio</label><input type="date" id="meta-date"></div>
            <div class="control-group" style="margin-top:10px;"><label>Valor</label><input type="number" id="meta-value"></div>
            <button class="btn-save" onclick="salvarMeta()" style="margin-top:20px; background:var(--success); color:white; border:none; padding:10px; width:100%; border-radius:6px; cursor:pointer;">Gravar Meta</button>
            <div class="list-container" id="meta-list" style="margin-top:20px; height:200px;"></div>
        </div>
        <div class="stat-card">
            <div class="log-header" style="background:transparent; padding-left:0; display:flex; justify-content:space-between;">
                <h3>üë• Equipe (<span id="total-users">0</span>)</h3>
                <button onclick="abrirModalUsuario()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">+ Novo</button>
            </div>
            <input type="text" id="search-user" placeholder="Buscar..." onkeyup="filtrarUsuarios()" style="width:100%; margin-bottom:10px;">
            <div class="list-container" id="user-list"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-user">
    <div class="modal">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Colaborador <span style="float:right; cursor:pointer;" onclick="fecharModal()">&times;</span></h3>
        <div class="control-group"><label>ID (Login)</label><input type="number" id="user-id"></div>
        <div class="control-group" style="margin-top:10px;"><label>Nome</label><input type="text" id="user-name"></div>
        <div class="control-group" style="margin-top:10px;"><label>Senha</label><input type="text" id="user-pass"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <div class="control-group" style="flex:1"><label>Fun√ß√£o</label><select id="user-role"><option>Assistente</option><option>Gestora</option><option>Auditora</option></select></div>
            <div class="control-group" style="flex:1"><label>Contrato</label><select id="user-contract"><option>PJ</option><option>CLT</option></select></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="salvarUsuario()" style="flex:1; background:var(--success); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer;">Salvar</button>
            <button id="btn-delete" onclick="excluirUsuario()" style="background:var(--danger); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; display:none;">Excluir</button>
        </div>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    if (SESSAO_ATUAL.funcao !== 'Gestora') window.location.href = 'produtividade.html';
    let allUsers = [];
    async function init() { await loadUsers(); await loadMetas(); document.getElementById('meta-date').value = new Date().toISOString().substring(0, 10); }
    
    async function loadUsers() {
        const { data } = await _supabase.from('usuarios').select('*').order('nome');
        allUsers = data; renderUsers(data); populateSelect(data);
    }
    function renderUsers(lista) {
        document.getElementById('total-users').innerText = lista.length;
        let html = '';
        lista.forEach(u => {
            const json = JSON.stringify(u).replace(/"/g, '&quot;');
            html += `<div class="list-item"><div><b>#${u.id}</b> ${u.nome} <span class="role-tag">${u.funcao}</span></div><button class="btn-action" onclick="abrirModalUsuario(${json})">Editar</button></div>`;
        });
        document.getElementById('user-list').innerHTML = html;
    }
    function abrirModalUsuario(u=null) {
        document.getElementById('modal-user').style.display = 'flex';
        const btnDel = document.getElementById('btn-delete');
        if(u) {
            document.getElementById('user-id').value = u.id; document.getElementById('user-id').disabled = true; document.getElementById('user-id').style.background='#eee';
            document.getElementById('user-name').value = u.nome; document.getElementById('user-pass').value = u.senha;
            document.getElementById('user-role').value = u.funcao; document.getElementById('user-contract').value = u.contrato || 'PJ';
            btnDel.style.display = 'block';
        } else {
            document.getElementById('user-id').value = ''; document.getElementById('user-id').disabled = false; document.getElementById('user-id').style.background='#fff';
            document.getElementById('user-name').value = ''; document.getElementById('user-pass').value = '';
            btnDel.style.display = 'none';
        }
    }
    function fecharModal() { document.getElementById('modal-user').style.display = 'none'; }
    
    async function salvarUsuario() {
        const id = document.getElementById('user-id').value; const nome = document.getElementById('user-name').value;
        const senha = document.getElementById('user-pass').value; const funcao = document.getElementById('user-role').value;
        const contrato = document.getElementById('user-contract').value;
        if(!id || !nome || !senha) return alert("Preencha tudo");
        const payload = { id: parseInt(id), nome, senha, funcao, contrato };
        
        if(document.getElementById('user-id').disabled) await _supabase.from('usuarios').update(payload).eq('id', id);
        else {
            const { error } = await _supabase.from('usuarios').insert(payload);
            if(error) return alert("Erro: ID j√° existe ou inv√°lido");
        }
        fecharModal(); loadUsers();
    }
    async function excluirUsuario() {
        if(confirm("Excluir?")) { await _supabase.from('usuarios').delete().eq('id', document.getElementById('user-id').value); fecharModal(); loadUsers(); }
    }
    function populateSelect(l) { 
        const s = document.getElementById('meta-user'); s.innerHTML='<option value="">Selecione...</option>';
        l.filter(u=>u.funcao==='Assistente').forEach(u=>s.innerHTML+=`<option value="${u.id}">${u.nome}</option>`);
    }
    function filtrarUsuarios() { const t = document.getElementById('search-user').value.toLowerCase(); renderUsers(allUsers.filter(u=>u.nome.toLowerCase().includes(t)||String(u.id).includes(t))); }
    
    async function loadMetas() {
        const { data } = await _supabase.from('metas').select('*, usuarios(nome)').order('data_inicio', {ascending:false}).limit(20);
        let h = ''; data.forEach(m => h += `<div class="list-item"><div>${m.usuarios?.nome}<br><small>${m.data_inicio}</small></div><b>${m.valor_meta}</b></div>`);
        document.getElementById('meta-list').innerHTML = h || 'Sem metas.';
    }
    async function salvarMeta() {
        const u = document.getElementById('meta-user').value; const d = document.getElementById('meta-date').value; const v = document.getElementById('meta-value').value;
        if(!u||!d||!v) return alert("Preencha meta");
        await _supabase.from('metas').insert({usuario_id:u, data_inicio:d, valor_meta:v});
        document.getElementById('meta-value').value=''; loadMetas(); alert("Salvo!");
    }
    init();
</script>
</body>
</html>
