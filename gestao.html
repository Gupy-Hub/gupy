<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o e Metas - Gupy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e11d48; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: #e2e8f0; }
        .tab-btn.active { background: var(--primary); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        th { background: #f1f5f9; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .hidden { display: none; }
        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; }
        .form-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap; }
    </style>
</head>
<body>

<div class="header">
    <h2>Painel de Gest√£o Gupy</h2>
    <div>
        <button class="btn" onclick="location.href='produtividade.html'" style="background:#0284c7; color:white; margin-right:10px;">üìä Importar / Produtividade</button>
        <span id="admin-nome">...</span> 
        <button class="btn" onclick="logout()" style="background:#64748b; color:white; margin-left:10px;">Sair</button>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('usuarios')">Usu√°rios</button>
    <button class="tab-btn" onclick="switchTab('metas')">Definir Metas</button>
</div>

<div id="tab-usuarios" class="card">
    <h3>Cadastro de Colaboradores</h3>
    <div class="form-row">
        <div><label>ID</label><br><input type="number" id="user-id"></div>
        <div><label>Nome</label><br><input type="text" id="user-nome"></div>
        <div><label>Fun√ß√£o</label><br><select id="user-funcao"><option value="Assistente">Assistente</option><option value="Auditora">Auditora</option><option value="Gestora">Gestora</option></select></div>
        <div><label>Contrato</label><br><select id="user-contrato"><option value="CLT">CLT</option><option value="PJ">PJ</option><option value="CLT PCD">CLT PCD</option></select></div>
        <button class="btn" style="background:#10b981; color:white;" onclick="salvarUsuario()">Salvar</button>
    </div>
    <table>
        <thead><tr><th>ID</th><th>NOME</th><th>FUN√á√ÉO</th><th>CONTRATO</th><th>A√á√ïES</th></tr></thead>
        <tbody id="tabela-usuarios"></tbody>
    </table>
</div>

<div id="tab-metas" class="card hidden">
    <h3>Hist√≥rico de Metas</h3>
    <div class="form-row">
        <div><label>Colaborador</label><br><select id="meta-user-select"></select></div>
        <div><label>Nova Meta</label><br><input type="number" id="meta-valor"></div>
        <div><label>Data In√≠cio</label><br><input type="date" id="meta-data"></div>
        <button class="btn" style="background:var(--primary); color:white;" onclick="salvarMeta()">Atualizar Meta</button>
    </div>
    <table>
        <thead><tr><th>COLABORADOR</th><th>META DI√ÅRIA</th><th>VIG√äNCIA</th></tr></thead>
        <tbody id="tabela-metas"></tbody>
    </table>
</div>

<script>
    const SB_URL = "https://glqrpsyjwozvislyxapj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdscXJwc3lqd296dmlzbHl4YXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTQyOTgsImV4cCI6MjA4MTgzMDI5OH0.etzcmIHgPcGC12HwZPTU2u0DLtJdF3XTBSYW38O7S-w";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    const sessao = JSON.parse(localStorage.getItem('usuario'));
    if (!sessao) window.location.href = 'index.html';
    document.getElementById('admin-nome').innerText = sessao.nome;
    document.getElementById('meta-data').valueAsDate = new Date();
    
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tab).classList.remove('hidden');
    }

    async function carregarUsuarios() {
        const { data } = await _supabase.from('usuarios').select('*').order('nome');
        const lista = document.getElementById('tabela-usuarios');
        const select = document.getElementById('meta-user-select');
        lista.innerHTML = '';
        select.innerHTML = '<option value="">Selecione...</option>';
        data.forEach(u => {
            lista.innerHTML += `<tr><td>${u.id}</td><td>${u.nome}</td><td>${u.funcao}</td><td>${u.contrato}</td><td><button class="btn" onclick="prepararEdicao(${u.id},'${u.nome}')">Editar</button></td></tr>`;
            if(u.funcao === 'Assistente') select.innerHTML += `<option value="${u.id}">${u.nome}</option>`;
        });
    }

    async function carregarMetas() {
        const { data } = await _supabase.from('metas').select('*, usuarios(nome)').order('data_inicio', { ascending: false });
        const lista = document.getElementById('tabela-metas');
        lista.innerHTML = '';
        data.forEach(m => {
            lista.innerHTML += `<tr><td>${m.usuarios?.nome || 'N/A'}</td><td>${m.valor_meta}</td><td>${new Date(m.data_inicio).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td></tr>`;
        });
    }

    async function salvarUsuario() {
        const id = document.getElementById('user-id').value;
        const nome = document.getElementById('user-nome').value;
        const { error } = await _supabase.from('usuarios').upsert([{ id, nome, funcao: document.getElementById('user-funcao').value, contrato: document.getElementById('user-contrato').value, is_admin: (document.getElementById('user-funcao').value==='Gestora') }]);
        if (error) alert("Erro ao salvar"); else carregarUsuarios();
    }

    async function salvarMeta() {
        const { error } = await _supabase.from('metas').insert([{ usuario_id: document.getElementById('meta-user-select').value, valor_meta: document.getElementById('meta-valor').value, data_inicio: document.getElementById('meta-data').value }]);
        if (error) alert("Erro meta"); else carregarMetas();
    }

    function logout() { localStorage.removeItem('usuario'); window.location.href = 'index.html'; }
    carregarUsuarios(); carregarMetas();
</script>
</body>
</html>
