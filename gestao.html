<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o</title>
    <link rel="icon" href="assets/img/favicon.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>.management-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; } .list-container { height: 400px; overflow-y: auto; } .list-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); align-items: center; } .list-item:hover { background: #f8fafc; } .role-tag { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; background: #e2e8f0; font-weight: 600; margin-left: 5px; }</style>
</head>
<body>
<div class="container">
    <div class="top-controls"><div><h1 style="font-size:1.5rem;color:var(--nav);">Painel de Gest√£o</h1></div></div>
    <div class="management-grid">
        <div class="column">
            <div class="card-form">
                <div class="card-header">üéØ Nova Meta</div>
                <div class="form-row"><div class="form-group"><label>Colaborador</label><select id="meta-user"></select></div><div class="form-group"><label>In√≠cio</label><input type="date" id="meta-date"></div></div>
                <div class="form-row"><div class="form-group"><label>Valor</label><input type="number" id="meta-value"></div></div>
                <button class="btn-save" onclick="salvarMeta()">Gravar Meta</button>
                <div style="margin-top:20px;"><div class="card-header" style="font-size:0.9rem;display:flex;justify-content:space-between;"><span>Metas Atuais</span><small id="today-display"></small></div><div class="list-container" id="meta-list"></div></div>
            </div>
        </div>
        <div class="column">
            <div class="card-form">
                <div class="card-header"><span>üë• Equipe (<span id="total-users">0</span>)</span><button onclick="abrirModalUsuario()" style="background:var(--primary);color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">+ Novo</button></div>
                <input type="text" id="search-user" placeholder="Buscar..." onkeyup="filtrarUsuarios()" style="width:100%;margin-bottom:10px;">
                <div class="list-container" id="user-list"></div>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-user">
    <div class="modal">
        <div class="card-header">Colaborador <span style="cursor:pointer" onclick="fecharModal()">&times;</span></div>
        <div class="form-group"><label>ID</label><input type="number" id="user-id"></div>
        <div class="form-group" style="margin-top:10px"><label>Nome</label><input type="text" id="user-name"></div>
        <div class="form-group" style="margin-top:10px"><label>Senha</label><input type="text" id="user-pass"></div>
        <div class="form-row" style="margin-top:10px"><div class="form-group"><label>Fun√ß√£o</label><select id="user-role"><option>Assistente</option><option>Gestora</option><option>Auditora</option></select></div><div class="form-group"><label>Contrato</label><select id="user-contract"><option>PJ</option><option>CLT</option></select></div></div>
        <div style="display:flex;gap:10px;margin-top:20px;"><button onclick="salvarUsuario()" class="btn-save">Salvar</button><button id="btn-delete" onclick="excluirUsuario()" class="btn-save" style="background:var(--danger);display:none;">Excluir</button></div>
    </div>
</div>
<script src="assets/js/config.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/layout.js"></script>
<script>
    if(SESSAO_ATUAL.funcao!=='Gestora') window.location.href='produtividade.html';
    let allUsers=[];
    async function init(){ const t=new Date(); document.getElementById('meta-date').value=t.toISOString().split('T')[0]; document.getElementById('today-display').innerText=t.toLocaleDateString(); await loadUsers(); await loadMetasAtuais(); }
    async function loadUsers(){ const{data}=await _supabase.from('usuarios').select('*').order('nome'); allUsers=data; renderUsers(data); populateSelect(data); }
    function renderUsers(l){ document.getElementById('total-users').innerText=l.length; let h=''; l.forEach(u=>{ h+=`<div class="list-item"><div><b>#${u.id}</b> ${u.nome}</div><button style="border:1px solid #ddd;background:#fff;padding:2px 8px;border-radius:4px;cursor:pointer;" onclick='abrirModalUsuario(${JSON.stringify(u)})'>‚úèÔ∏è</button></div>`; }); document.getElementById('user-list').innerHTML=h; }
    function populateSelect(l){ const s=document.getElementById('meta-user'); s.innerHTML='<option value="">Selecione...</option>'; l.filter(u=>u.funcao==='Assistente').forEach(u=>s.innerHTML+=`<option value="${u.id}">${u.nome}</option>`); }
    function filtrarUsuarios(){ const t=document.getElementById('search-user').value.toLowerCase(); renderUsers(allUsers.filter(u=>u.nome.toLowerCase().includes(t)||String(u.id).includes(t))); }
    async function loadMetasAtuais(){ 
        const c=document.getElementById('meta-list'); c.innerHTML='Carregando...';
        const{data:as}=await _supabase.from('usuarios').select('id,nome').eq('funcao','Assistente').order('nome');
        const{data:ms}=await _supabase.from('metas').select('*').order('data_inicio',{ascending:false});
        if(!as.length){c.innerHTML='Sem assistentes.';return;}
        let h=''; const hoje=new Date().toISOString().split('T')[0];
        as.forEach(a=>{ const m=ms.find(x=>x.usuario_id===a.id && x.data_inicio<=hoje); h+=`<div class="list-item"><div><b>${a.nome}</b><br><small>${m?m.data_inicio.split('-').reverse().join('/'):'-'}</small></div><b style="font-size:1.1rem;${m?'color:var(--nav)':'color:#ccc'}">${m?m.valor_meta:0}</b></div>`; });
        c.innerHTML=h;
    }
    function abrirModalUsuario(u=null){ 
        document.getElementById('modal-user').style.display='flex'; const b=document.getElementById('btn-delete'); const i=document.getElementById('user-id');
        if(u){ i.value=u.id; i.disabled=true; document.getElementById('user-name').value=u.nome; document.getElementById('user-pass').value=u.senha; document.getElementById('user-role').value=u.funcao; document.getElementById('user-contract').value=u.contrato||'PJ'; b.style.display='block'; }
        else{ i.value=''; i.disabled=false; document.getElementById('user-name').value=''; document.getElementById('user-pass').value=''; b.style.display='none'; }
    }
    function fecharModal(){ document.getElementById('modal-user').style.display='none'; }
    async function salvarUsuario(){ 
        const i=document.getElementById('user-id').value, n=document.getElementById('user-name').value, s=document.getElementById('user-pass').value, f=document.getElementById('user-role').value, c=document.getElementById('user-contract').value;
        if(!i||!n||!s) return alert('Preencha tudo');
        const p={id:parseInt(i),nome:n,senha:s,funcao:f,contrato:c};
        if(document.getElementById('user-id').disabled) await _supabase.from('usuarios').update(p).eq('id',i);
        else { const{error}=await _supabase.from('usuarios').insert(p); if(error) return alert('Erro: ID duplicado?'); }
        fecharModal(); await loadUsers(); await loadMetasAtuais();
    }
    async function excluirUsuario(){ if(confirm('Excluir?')){ await _supabase.from('usuarios').delete().eq('id',document.getElementById('user-id').value); fecharModal(); await loadUsers(); await loadMetasAtuais(); } }
    async function salvarMeta(){ const u=document.getElementById('meta-user').value, d=document.getElementById('meta-date').value, v=document.getElementById('meta-value').value; if(!u||!d||!v)return alert('Preencha'); await _supabase.from('metas').insert({usuario_id:u,data_inicio:d,valor_meta:v}); document.getElementById('meta-value').value=''; loadMetasAtuais(); alert('Salvo!'); }
    init();
</script>
</body>
</html>
